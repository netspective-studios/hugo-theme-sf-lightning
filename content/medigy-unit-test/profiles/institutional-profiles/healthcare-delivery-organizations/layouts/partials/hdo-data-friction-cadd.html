{{ $instId:= $.Scratch.Get "instId" }}
{{ $instName:= $.Scratch.Get "instName" }}
{{ $vendorId:= $.Scratch.Get "vendorid" }}
{{ $claimStatus:= $.Scratch.Get "claimStatus" }}
{{ $.Scratch.Add  "dataFrictionCount"  20 }}
{{ range first 1 .Site.Data.hdo_data_friction_lhc_form.items }}

{{ range .items }}
  {{ $.Scratch.Add "dataFrictionCount" 1 }}
  {{ $dataFrictionCount:= $.Scratch.Get "dataFrictionCount" }}
    {{ if eq .dataType "CNE" }}     
      {{ if (eq (.answers | len) 2) }}     
        <article class="yes-no-row inn-click"> 
                  
          <div class="row answerPatientAccessStatus question-{{ .questionCode}}">
            <div class="col-md-5">
              <i class="{{ .prefix }} icon-position-1"></i>
              <h4 id="text-{{ .questionCode}}" class="pl-5 normal-heading">{{ .question}}</h4>
            </div>
              {{ $questionCode := .questionCode}}
              {{ $localQuestionCode := .localQuestionCode}}
              {{ range .answers | first 1 }}
              {{ $.Scratch.Set "option1"  .label }}
              {{ end }}
              {{ range .answers | last 1 }}
              {{ $.Scratch.Set "option2"  .label }}
              {{ end }}
              {{ $option1:= $.Scratch.Get "option1" }}
              {{ $option2:= $.Scratch.Get "option2" }}
              {{ $id_first:= lower $option1 }}
              {{ $id_second:= lower $option2 }}  

            <div id="btn-{{ .questionCode}}" class="col-md-2 yes-no-btns">                                         
              <button class="new-ofer-btn-1 {{ $id_first }} btn white fix-width-yes-btn" id="{{$id_first}}-{{ $questionCode}}" type="button"  data-metric="{{ $localQuestionCode}}" data-title="{{ $instName }}" data-id="{{ $instId }}" data-label="{{$option1}}" ><i class="fas fa-thumbs-up"></i> {{ $option1}} </button>             
              <button class="new-ofer-btn-1 {{ $id_second }} btn white fix-width-yes-btn" id="{{$id_second}}-{{ .questionCode}}" type="button" data-metric="{{ .localQuestionCode}}" data-title="{{ $instName }}" data-id="{{ $instId }}" data-label="{{$option2}}" ><i class="fas fa-thumbs-down"></i> {{ $option2}} </button>         
            </div>
            <!-- additional info items >>> starts -->
            <div class="col-md-5">
              <div class="add-info-col">
                <div class="hdo-edit"><!-- edit -->
                  <div id="icon-answered-date-{{ .questionCode}}" class="ans-update-date icon-{{ .questionCode}} edit-{{ .questionCode}}" style="display:none;">
                    <a class="update-btn-edit" id="edit-btn-{{ .questionCode}}" href="javascript:void(0)">                 
                      <span id="top-question-updated-on-{{ .questionCode}}" class="pl-4"> 
                        <i class="far fa-edit hdo-icon-position"></i> Edit
                      </span>
                    </a>                      
                  </div>
                </div>
                <div class="hdo-reset" id="hdo-reset-{{ $questionCode}}" style="display:none"><!-- reset -->
                  <span class="hdo-icon-space"><i class="fas fa-redo hdo-icon-position"></i> Reset</span>
                </div>
                <div class="hdo-endorsed" id="hdo-endorsed-{{ .questionCode}}" ><!-- endorsed -->
                  <div id="endorsed-count-{{ .questionCode}}" >
                  <span class="hdo-icon-space" id="endorsed-agree-{{ .questionCode}}">
                    <i class="far fa-check-circle hdo-icon-position"></i> Endorsed (<span class="" id="{{ .questionCode }}-agree-count">0</span>)
                  </span>
                  </div>              
                </div>
                <div class="hdo-updated-date" id="hdo-updated-date-{{ .questionCode}}"><!-- updated-date -->
                  <span class="count-tool-i special-text">
                    <span class="hdo-icon-space" id="updated-short-{{ .questionCode}}">
                    <i class="far fa-clock hdo-icon-position"></i>
                    <span>Updated</span>
                    <span class="timeago" id="days-ago-id-innovator-{{ .questionCode}}" datetime=""></span>
                    </span>
                    <span class="special-text__tooltip" id="answer-updated-on-{{ .questionCode}}" ></span>
                  </span>
                </div>
                <div class="hdo-not-claimed" id="not-claimed-text-{{ .questionCode}}" style="display:none"><!-- HDO not claimed text -->
                  <span class="count-tool-i special-text">
                    <span class="hdo-icon-space" id="not-claimed-short-{{ .questionCode}}">
                    <i class="fas fa-info-circle hdo-icon-position"></i>
                    <span>This HDO is not claimed</span>
                    </span>
                    <span class="special-text__tooltip" id="hdo-not-claimed-{{ .questionCode}}" > {{ print $instName " is not claimed. If you are a member of this HDO please  claim ownership or else invite someone who can claim and fill this information." }}</span>
                  </span>
                </div> 
                <div class="hdo-not-claimed" id="not-answered-text-{{ .questionCode}}" style="display:none" ><!-- HDO not Answered text -->               
                  <span class="hdo-icon-space" id="not-answered-short-{{ .questionCode}}">
                    <i class="fas fa-info-circle hdo-icon-position"></i>
                    <span>Not answered</span>
                  </span>               
                </div>
              </div>
              <div class="clearfix"></div>
              <div class="hdo-user-endorse-btn"><!-- endorse button -->
                <div id="btn-answer-{{ .questionCode}}" class="text-right">
                  <button class="endorse-btn"  id="endorsebtn-{{ .questionCode}}" type="button" data-title="{{ $instName }}" data-id="{{ $instId}}" data-metric="{{ .localQuestionCode}}">Endorse </button>
                </div>
              </div>
            </div>
            <!-- additional info items <<< ends -->
          </div>
          <div class="alert alert-secondary innovator-edit-box" id="edit-badge-{{ .questionCode}}" style="display:none">
            <div class="row">
              <div class="col-md-6">{{ .question}}</div>                                   
              <div class="col-md-6">
                <button class="new-ofer-btn-1 {{ $id_first }} btn white fix-width-yes-btn" id="edit-{{$id_first}}-{{ $questionCode}}" type="button"  data-action="update" data-metric="{{ $localQuestionCode}}" data-title="{{ $instName }}" data-id="{{ $instId }}" data-label="{{$option1}}" ><i class="fas fa-thumbs-up"></i> {{ $option1}} </button>             
                <button class="new-ofer-btn-1 {{ $id_second }} btn white fix-width-yes-btn" id="edit-{{$id_second}}-{{ .questionCode}}" type="button" data-action="update" data-metric="{{ .localQuestionCode}}" data-title="{{ $instName }}" data-id="{{ $instId }}" data-label="{{$option2}}" ><i class="fas fa-thumbs-down"></i> {{ $option2}} </button>                      
                <button type="button" class="close" id="close-btn-{{ .questionCode}}" aria-label="Close">
                <span aria-hidden="true">&times;</span>
                </button>
              </div> 
            </div> 
          </div>      
        </article>
        <script>
          /// Get data on page load starts here ////
            {{ $code1 := print  "code1_" $dataFrictionCount }}
            {{ $code2 := print  "code2_" $dataFrictionCount }}       
            var {{ safeJS  ($code1) }}="{{ $option1}}";
            var {{ safeJS  ($code2) }}="{{ $option2}}";  
            var metricName =  "medigy_qual_exp_institution_data_friction{{ .localQuestionCode}}"; 
            var institutionId = "{{ $instId }}";           
            var serviceData = { "url": "{{ $.Site.Params.GraphQLUrl }}", "method": "GET", "query": "query{\n  getPromData(metricName:\""+ metricName +"\",metricQuery:\"{institutionId=\\\""+institutionId+"\\\"}[1y]\",groupByParam:[\"institutionId\"]){\n    prometheusData\n    status\n  }\n}" };
            ajaxPageServiceCall.serviceCall(serviceData).then(questionResponse => {
              if(questionResponse.data.getPromData.status == "success"){
                var JSONData = JSON.parse(questionResponse.data.getPromData.prometheusData);
                if(JSONData.length > 0){
                  for(i =0; i< (JSONData.length);i++){
                    timestamp = JSONData[i]['time'];
                    updatedDate = new Date(timestamp * 1000);
                    var months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
                    var currentMonth= months[updatedDate.getMonth()];
                    var date = updatedDate.getDate();
                    var year = updatedDate.getFullYear(); 
                    var answeredDate = currentMonth+" "+date+", "+year;               
                    if(JSONData[i]['selectedVal'] == {{ safeJS  ($code1) }})
                    {
                      $("#{{$id_second}}-{{ .questionCode }}").hide(); 
                      var labelStatusPatientAccess = "Answered on ";
                      if(JSONData[i]['addUpdateStatus'])
                        (JSONData[i]['addUpdateStatus']=="update") ? labelStatusPatientAccess= "Updated on " : labelStatusPatientAccess = "Answered on "; 
                      $("#answer-updated-on-{{ .questionCode}}").text(labelStatusPatientAccess+answeredDate+ " by Senior Executive at "+ {{ $instName}});
                      $("#days-ago-id-innovator-{{ .questionCode}}").attr("datetime", timestamp);
                      $("#edit-{{$id_first}}-{{ $questionCode}}").attr("disabled", true);                       
                    }
                    else if(JSONData[i]['selectedVal'] == {{ safeJS  ($code2) }})
                    {                    
                      $("#{{$id_first}}-{{ .questionCode }}").hide(); 
                      var labelStatusPatientAccess = "Answered on ";
                      if(JSONData[i]['addUpdateStatus'])
                        (JSONData[i]['addUpdateStatus']=="update") ? labelStatusPatientAccess= "Updated on " : labelStatusPatientAccess = "Answered on ";
                      $("#answer-updated-on-{{ .questionCode}}").text(labelStatusPatientAccess +answeredDate+ " by Senior Executive at "+ {{ $instName}});                      
                      $("#days-ago-id-innovator-{{ .questionCode}}").attr("datetime", timestamp);
                      $("#edit-{{$id_second}}-{{ $questionCode}}").attr("disabled", true);                                       
                    }              
                  }       
                  $('#answerDataFrictionStatus').val(1);
                  timeAgo();
                }
                else  // question is not answered by innovator
                $('#answerDataFrictionStatus').val(0); 
              } 
              
              $("#{{$id_first}}-{{ $questionCode}}, #{{$id_second}}-{{ $questionCode}}").attr("disabled", true);   
              if({{ $claimStatus}} != true){ //not  claimed
                $("#{{$id_first}}-{{ $questionCode}}, #{{$id_second}}-{{ $questionCode}}").attr("disabled", true);
                $("#{{$id_first}}-{{ $questionCode}}, #{{$id_second}}-{{ $questionCode}}" ).addClass("fade-btn");
              }
              if(getCookie('personid') != "{{ $vendorId}}" && {{ $claimStatus}} == true  && $('#answerDataFrictionStatus').val() !=1){
                $("#{{$id_first}}-{{ $questionCode}}, #{{$id_second}}-{{ $questionCode}}").attr("disabled", true);
                $("#{{$id_first}}-{{ $questionCode}}, #{{$id_second}}-{{ $questionCode}}" ).addClass("fade-btn");
              }     
              // innovator login 
              if( getCookie('personid') == "{{ $vendorId}}"){
                $('.hdo-user-endorse-btn').hide();
                //$('#hdo-reset-{{ .questionCode}}').show(); // uncomment after implementation
                $('.edit-{{ .questionCode}}').show();
              }               
              // if not anwered and vendor login in
              if(getCookie('personid') == "{{ $vendorId}}" && {{ $claimStatus}} == true  && $('#answerDataFrictionStatus').val() !=1){
                $("#{{$id_first}}-{{ $questionCode}}, #{{$id_second}}-{{ $questionCode}}").attr("disabled", false);
                $('#hdo-reset-{{ .questionCode}}').hide();
              } 
              // if not claimed
              if({{ $claimStatus}} != true){
                $("#not-claimed-text-{{ $questionCode}}").show();
              }
              // if not claimed and not answered
              if({{ $claimStatus}} == true && $('#answerDataFrictionStatus').val() ==0 ){
                $("#not-answered-text-{{ $questionCode}}").show();
              }
              // if not answered and public
              if($('#answerDataFrictionStatus').val() ==0 && getCookie('personid') != "{{ $vendorId}}"  ){
                $('#hdo-updated-date-{{ $questionCode}}').hide();
                $('#endorse-anonymous-{{ $questionCode}}').hide();
                $('#hdo-endorsed-{{ $questionCode}}').hide();
                $('#hdo-reset-{{ $questionCode}}').hide();
              } 
              // Not answered case
              if($('#answerDataFrictionStatus').val() !=1){
                $("#icon-answered-date-{{ .questionCode}}").hide();  
                $('#hdo-endorsed-{{ $questionCode}}').hide();
                $('#hdo-updated-date-{{ $questionCode}}').hide();
                $('#hdo-reset-{{ $questionCode}}').hide();
                $('#endorsebtn-{{ $questionCode}}').hide();             
              }   
            })
            .catch(error => {
                console.log(error);
            });      
          /// Get data ends here ////

          $('#edit-btn-{{ .questionCode}}').click(function(){
            $("#edit-badge-{{ .questionCode}}").show();
          });
          $('#close-btn-{{ .questionCode}}').click(function(){
            $("#edit-badge-{{ .questionCode}}").hide();
          });

          /// Yes Push data starts here ////
            $("#{{$id_first}}-{{ .questionCode }}, #edit-{{$id_first}}-{{ .questionCode }}").on("click", function (e) {   
              var personid = getCookie('personid');
              var userEmail = getCookie('userEmail');
              var productName = $(this).attr('data-title');      
              var btn_label = $(this).attr('data-label');  
              var addUpdateStatus = ($(this).attr('data-action')) ? $(this).attr('data-action') : "Add";
              var updatedPerson = getCookie('firstname')+" "+getCookie('lastname');
              gtmAddproduct(productName,userEmail); 
              if( personid != '' && personid != null && getCookie('sessionId')!= null && getCookie('sessionId')!= '' ) {         
                var timestamp = Date.now();
                var institutionId = $(this).attr('data-id');
                var source = "hospital-compare-"+institutionId;
                var selectedVal = btn_label;
                updatedDate = new Date(timestamp);
                var months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
                var currentMonth= months[updatedDate.getMonth()];
                var date = updatedDate.getDate();
                var year = updatedDate.getFullYear(); 
                var answeredDate = currentMonth+" "+date+", "+year; 
                var metricName ="medigy_qual_exp_institution_data_friction"+$(this).attr('data-metric');   
                var serviceData = { "url": "{{ $.Site.Params.GraphQLUrl }}", "method": "POST", "query": "mutation {\n  addPrometheusData(\n    metricData: [\n    \t{\n        key: \"institutionId\", \n        value: \""+institutionId+"\"\n      }, \n      {\n        key: \"updatedPerson\", \n        value: \""+updatedPerson+"\"\n      }, \n      {\n        key: \"addUpdateStatus\", \n        value: \""+addUpdateStatus+"\"\n      }, \n      {\n        key: \"selectedVal\", \n        value: \""+selectedVal+"\"\n      }, \n      {\n        key: \"updatedDate\", \n        value: \""+updatedDate+"\"\n      }, \n      {\n        key: \"source\", \n        value: \""+source+"\"\n      }, \n      {\n        key: \"createdat\", \n        value: \""+timestamp+"\"\n      }, \n      {\n        key: \"userId\", \n        value: \""+personid+"\"\n      }\n    ], \n    pushGatewayPort: \"\", \n    prometheusJobName: \""+ metricName +"\", \n    metricName: \""+metricName+"\") {\n    status\n    message\n    errorCode\n  }\n}" };
                ajaxPageServiceCall.serviceCall(serviceData).then(response => {
                  if(response.data.addPrometheusData.status == "SUCCESS"){
                      $("#{{$id_first}}-{{ .questionCode }}").show();
                      $("#{{$id_second}}-{{ .questionCode }}").hide();
                      $("#edit-badge-{{ .questionCode}}").hide();
                      $("#edit-{{$id_first}}-{{ .questionCode}}").attr("disabled", true);
                      $("#edit-{{$id_second}}-{{ .questionCode}}").attr("disabled", false);
                      $("#days-ago-id-innovator-{{ .questionCode}}").text(" just now");
                      $("#answer-updated-on-{{ .questionCode}}").text("Updated just now");
                      $("#not-answered-text-{{ $questionCode}}").hide();
                  }  
                })
                .catch(error => {
                    console.log(error);
                });
              }
              else{
                if (getCookie('personid') == null)
                $('#loginModalCenter').modal('toggle');
                else
                $('#reLoginModalCenter').modal('toggle');
              }
            });
          /// Yes Push data ends here ////
        
          /// No push data starts here
            $("#{{$id_second}}-{{ .questionCode }}, #edit-{{$id_second}}-{{ .questionCode }}").on("click", function (e) {   
              var personid = getCookie('personid');
              var userEmail = getCookie('userEmail');
              var productName = $(this).attr('data-title');      
              var btn_label = $(this).attr('data-label');  
              var addUpdateStatus = ($(this).attr('data-action')) ? $(this).attr('data-action') : "Add";
              var updatedPerson = getCookie('firstname')+" "+getCookie('lastname');   
              gtmAddproduct(productName,userEmail); 
              if( personid != '' && personid != null && getCookie('sessionId')!= null && getCookie('sessionId')!= '' ) {         
                var timestamp = Date.now();
                var institutionId = $(this).attr('data-id');
                var source = "hospital-compare-"+institutionId;
                var selectedVal = btn_label;
                updatedDate = new Date(timestamp);
                var months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
                var currentMonth= months[updatedDate.getMonth()];
                var date = updatedDate.getDate();
                var year = updatedDate.getFullYear(); 
                var answeredDate = currentMonth+" "+date+", "+year;
                var metricName ="medigy_qual_exp_institution_data_friction"+$(this).attr('data-metric');
                var serviceData = { "url": "{{ $.Site.Params.GraphQLUrl }}", "method": "POST", "query": "mutation {\n  addPrometheusData(\n    metricData: [\n    \t{\n        key: \"institutionId\", \n        value: \""+institutionId+"\"\n      }, \n      {\n        key: \"updatedPerson\", \n        value: \""+updatedPerson+"\"\n      }, \n      {\n        key: \"addUpdateStatus\", \n        value: \""+addUpdateStatus+"\"\n      }, \n      {\n        key: \"selectedVal\", \n        value: \""+selectedVal+"\"\n      }, \n      {\n        key: \"source\", \n        value: \""+source+"\"\n      }, \n      {\n        key: \"createdat\", \n        value: \""+timestamp+"\"\n      }, \n      {\n        key: \"userId\", \n        value: \""+personid+"\"\n      }\n    ], \n    pushGatewayPort: \"\", \n    prometheusJobName: \""+ metricName +"\", \n    metricName: \""+metricName+"\") {\n    status\n    message\n    errorCode\n  }\n}" };
                ajaxPageServiceCall.serviceCall(serviceData).then(response => {
                  if(response.data.addPrometheusData.status == "SUCCESS"){
                    $("#{{$id_second}}-{{ .questionCode }}").show();
                    $("#{{$id_first}}-{{ .questionCode}}").hide();
                    $("#edit-badge-{{ .questionCode}}").hide();
                    $("#edit-{{$id_first}}-{{.questionCode}}").attr("disabled", false);
                    $("#edit-{{$id_second}}-{{ .questionCode}}").attr("disabled", true);
                    $("#days-ago-id-innovator-{{ .questionCode}}").text(" just now");
                    $("#answer-updated-on-{{ .questionCode}}").text("Updated just now");
                    $("#not-answered-text-{{ $questionCode}}").hide();
                  }
                })
                .catch(error => {
                    console.log(error);
                });
              }
              else{
                if (getCookie('personid') == null)
                $('#loginModalCenter').modal('toggle');
                else
                $('#reLoginModalCenter').modal('toggle');
              }
            });
          /// No push data ends here

          /// Endorse Button
          /// Get data on page load starts here ////
            var metricName =  "medigy_qual_exp_institution_inno_answer_{{ .localQuestionCode}}"; 
            var institutionId = "{{ $instId }}";
            var serviceData = { "url": "{{ $.Site.Params.GraphQLUrl }}", "method": "GET", "query": "query{\n  getPromData(metricName:\""+ metricName +"\",metricQuery:\"{institutionId=\\\""+institutionId+"\\\"}[1y]\",groupByParam:[\"userId\",\"institutionId\"]){\n    prometheusData\n    status\n  }\n}" };
            ajaxPageServiceCall.serviceCall(serviceData).then(questionResponse => {
              if(questionResponse.data.getPromData.status == "success"){
                var JSONData = JSON.parse(questionResponse.data.getPromData.prometheusData);
                var userArray = JSONData.filter(function (el) {
                  return el.userId == getCookie('personid')
                });
                if(JSONData.length > 0){
                  var yescount=0;
                  var nocount=0;
                  for(i =0; i< (JSONData.length);i++){
                    if(JSONData[i]['selectedVal'] == "1" || JSONData[i]['selectedVal'] == "01")
                      yescount++;  
                    else if (JSONData[i]['selectedVal'] == "0" || JSONData[i]['selectedVal'] == "02")
                      nocount++;                   
                  }
                  $('#{{ .questionCode }}-agree-count').html(yescount);
                  for(var i=0; i<userArray.length; i++){		
                    if (userArray[i].userId == getCookie('personid')){
                      if(JSONData[i]['selectedVal'] == "1" || JSONData[i]['selectedVal'] == "01"){
                        $("#endorsebtn-{{ .questionCode}}" ).addClass("endorsed");
                        $("#endorsebtn-{{ .questionCode}}").html("Endorsed");
                      }
                    }
                  }
                } else {
                  $('#hdo-endorsed-{{ .questionCode}}').hide();
                }
              }  
            })
            .catch(error => {
                console.log(error);
            });             
          /// Get data ends here ////

          /// Endorse Push data starts here ////
            $("#endorsebtn-{{ .questionCode }}").on("click", function (e) {  
              $('#agree-{{ .questionCode}}').prop('disabled', true);
              var personid = getCookie('personid');
              var userEmail = getCookie('userEmail');
              var productName = $(this).attr('data-title');      
              gtmAddproduct(productName,userEmail); 
              if( personid != '' && personid != null && getCookie('sessionId')!= null && getCookie('sessionId')!= '' ) {         
                var timestamp = Date.now();
                var institutionId = $(this).attr('data-id');
                var source = "hospital-compare-"+institutionId;
                var selectedVal = "1";
                var metricName ="medigy_qual_exp_institution_inno_answer_"+$(this).attr('data-metric');
                var serviceData = { "url": "{{ $.Site.Params.GraphQLUrl }}", "method": "POST", "query": "mutation {\n  addPrometheusData(\n    metricData: [\n    \t{\n        key: \"institutionId\", \n        value: \""+institutionId+"\"\n      }, \n      {\n        key: \"selectedVal\", \n        value: \""+selectedVal+"\"\n      }, \n      {\n        key: \"source\", \n        value: \""+source+"\"\n      }, \n      {\n        key: \"createdat\", \n        value: \""+timestamp+"\"\n      }, \n      {\n        key: \"userId\", \n        value: \""+personid+"\"\n      }\n    ], \n    pushGatewayPort: \"\", \n    prometheusJobName: \""+ metricName +"\", \n    metricName: \""+metricName+"\") {\n    status\n    message\n    errorCode\n  }\n}" };
                ajaxPageServiceCall.serviceCall(serviceData).then(response => {
                  if(response.data.addPrometheusData.status == "SUCCESS"){
                    var currentyescount=$('#{{ .questionCode }}-agree-count').html();
                    currentyescount++;
                    $('#{{ .questionCode }}-agree-count').html(currentyescount);
                    $("#endorsebtn-{{ .questionCode}}").attr("disabled", true);
                    $("#endorsebtn-{{ .questionCode}}" ).addClass("endorsed");
                    $("#endorsebtn-{{ .questionCode}}").html("Endorsed");                                      
                  }  
                })
                .catch(error => {
                    console.log(error);
                });
              }
              else{
                if (getCookie('personid') == null)
                $('#loginModalCenter').modal('toggle');
                else
                $('#reLoginModalCenter').modal('toggle');
              }
            });
          /// Endorse Push data ends here ////

        </script>
     
      {{ end }} 
    {{ end }}
  {{ end }}
{{ end }}
<script>
 function timeAgo(selector) {
    var templates = {
        prefix: "",
        suffix: " ago",
        seconds: "a min",
        minute: "a min",
        minutes: "%d min",
        hour: "an hour",
        hours: "%d hours",
        day: "a day",
        days: "%d days",
        month: "a month",
        months: "%d months",
        year: "a year",
        years: "%d years"
    };
    var template = function(t, n) {
        return templates[t] && templates[t].replace(/%d/i, Math.abs(Math.round(n)));
    };

    var timer = function(time) {
        if (!time)
            return;
        time = time.replace(/\.\d+/, ""); // remove milliseconds
        time = time.replace(/-/, "/").replace(/-/, "/");
        time = time.replace(/T/, " ").replace(/Z/, " UTC");
        time = time.replace(/([\+\-]\d\d)\:?(\d\d)/, " $1$2"); // -04:00 -> -0400
        time = new Date(time * 1000 || time);

        var now = new Date();
        var seconds = ((now.getTime() - time) * .001) >> 0;
        var minutes = seconds / 60;
        var hours = minutes / 60;
        var days = hours / 24;
        var years = days / 365;

        return templates.prefix + (
                seconds < 45 && template('seconds', seconds) ||
                seconds < 90 && template('minute', 1) ||
                minutes < 45 && template('minutes', minutes) ||
                minutes < 90 && template('hour', 1) ||
                hours < 24 && template('hours', hours) ||
                hours < 42 && template('day', 1) ||
                days < 30 && template('days', days) ||
                days < 45 && template('month', 1) ||
                days < 365 && template('months', days / 30) ||
                years < 1.5 && template('year', 1) ||
                template('years', years)
                ) + templates.suffix;
    };

    var elements = document.getElementsByClassName('timeago');
    for (var i in elements) {
        var $this = elements[i];
        if (typeof $this === 'object') {
            $this.innerHTML = timer($this.getAttribute('title') || $this.getAttribute('datetime'));
        }
    }
    // update time every minute
  //  setTimeout(timeAgo, 60000);
 }
</script>